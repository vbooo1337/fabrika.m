<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Учет смены продукции</title>
<style>
body { margin:0; padding:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; background:#000; color:#fff; display:flex; flex-direction:column; align-items:center; min-height:100vh; font-size:18px; }
h1 { margin:20px 0 10px; font-size:1.5rem; text-align:center; }
button { padding:10px 12px; margin:5px; background:#1a1a1a; color:#fff; border:1px solid #555; border-radius:6px; cursor:pointer; font-size:16px; text-transform:uppercase; }
button:hover { background:#333; }
#controls { display:flex; flex-wrap:wrap; justify-content:center; margin-bottom:10px; }
#controls select, #controls input[type="number"] { padding:8px; margin:5px; border-radius:6px; border:1px solid #555; background:#1a1a1a; color:#fff; font-size:16px; }
#summary { display:flex; justify-content:center; gap:15px; margin-bottom:10px; font-size:16px; }
#stageContainer { background:#111; border-radius:10px; width:95%; max-width:600px; flex:1; overflow-y:auto; padding:10px; margin-bottom:20px; }
.card { background:#1a1a1a; border-radius:8px; padding:10px; margin-bottom:10px; transition:0.3s; }
.card.green { background-color:#00640033; }
.card.yellow { background-color:#b8860b33; }
.card-title { font-weight:bold; font-size:1rem; }
.progress-bar { width:100%; height:10px; background:#333; border-radius:5px; overflow:hidden; margin-top:5px; }
.progress-fill { height:100%; transition:width 0.3s; }
@media (max-width:600px) { #controls { flex-direction:column; align-items:stretch; } button, select, input { width:100%; box-sizing:border-box; }
}
</style>
</head>
<body>
<h1>УЧЕТ СМЕНЫ</h1>
<div id="controls">
<button id="newShiftBtn">НАЧАТЬ НОВУЮ СМЕНУ</button>
<select id="stageSelect"></select>
<select id="categorySelect"></select>
<select id="productSelect"></select>
<input type="number" id="productQty" value="1" min="1">
<button id="addProductBtn">ДОБАВИТЬ</button>
<button id="saveBtn">СОХРАНИТЬ</button>
</div>
<div id="summary"></div>
<div id="stageContainer"></div>
<script>
const stages=['СОГНУТЫ','СВАРЕНЫ','УПАКОВАНЫ'];
const productsCatalog={
  'ВАННЫ':['Односекц. 530x530','Односекц. 530x585','Односекц. 530x600','Односекц. 600x600','Односекц. 1000x600','Двухсекц. 1000x600','Двухсекц. 1010x530','Двухсекц. 1010x585','Двухсекц. 1200x600'],
  'СТОЛЫ':['600x600 С/Б','600x600 Б/Б','800x700 С/Б','800x700 Б/Б','800x700 С/Б+П','800x700 Б/Б+П','1000x600 С/Б','1000x600 Б/Б','1000x600 С/Б+П','1000x600 Б/Б+П','1200x600 С/Б','1200x600 Б/Б','1200x600 С/Б+П','1200x600 Б/Б+П','1500x600 С/Б','1500x600 Б/Б','1500x600 С/Б+П','1500x600 Б/Б+П','1000x700 С/Б','1000x700 Б/Б','1000x700 С/Б+П','1000x700 Б/Б+П','1200x700 С/Б','1200x700 Б/Б','1200x700 С/Б+П','1200x700 Б/Б+П','1500x700 С/Б','1500x700 Б/Б','1500x700 С/Б+П','1500x700 Б/Б+П'],
  'ПОЛКИ НАВЕСНЫЕ':['500x300','600x300','900x300','1000x300','1200x300','1500x300'],
  'СТЕЛАЖ':['—'],
  'РУКОМОЙНИК':['—']
};
let currentShift={},currentSha='',activeStage=stages[0];
const stageSelectEl=document.getElementById('stageSelect'); stages.forEach(s=>{const opt=document.createElement('option');opt.value=s;opt.textContent=s;stageSelectEl.appendChild(opt);}); stageSelectEl.value=activeStage; stageSelectEl.addEventListener('change',()=>{activeStage=stageSelectEl.value; renderStage();});
const categorySelect=document.getElementById('categorySelect'); const productSelect=document.getElementById('productSelect');
for(let cat in productsCatalog){const opt=document.createElement('option');opt.value=cat;opt.textContent=cat;categorySelect.appendChild(opt);}
function updateProductSelect(){ const cat=categorySelect.value; productSelect.innerHTML=''; productsCatalog[cat].forEach(p=>{const opt=document.createElement('option');opt.value=p;opt.textContent=p; productSelect.appendChild(opt);});}
categorySelect.addEventListener('change',updateProductSelect); updateProductSelect();
document.getElementById('addProductBtn').addEventListener('click',()=>{ const cat=categorySelect.value,prod=productSelect.value,qty=parseInt(document.getElementById('productQty').value); if(activeStage==='СВАРЕНЫ'){if(cat==='ПОЛКИ НАВЕСНЫЕ'&&prod!=='1500x300'){alert('На этапе СВАРЕНЫ эта полка недоступна');return;} if(cat==='СТЕЛАЖ'){alert('Стеллаж недоступен на этапе СВАРЕНЫ');return;}} if(!currentShift[cat])currentShift[cat]={}; if(!currentShift[cat][prod])currentShift[cat][prod]={СОГНУТЫ:0,СВАРЕНЫ:0,УПАКОВАНЫ:0}; currentShift[cat][prod][activeStage]+=qty; renderStage(); });
document.getElementById('newShiftBtn').addEventListener('click',()=>{if(confirm('Начать новую смену?')){currentShift={}; currentSha=''; renderStage();}});
document.getElementById('saveBtn').addEventListener('click',saveShift);
async function loadShift(){ try{ const res=await fetch('/api/loadShift'); const data=await res.json(); currentShift=data.shift; currentSha=data.sha; renderStage(); } catch(e){ alert('Ошибка загрузки: '+e.message); } }
async function saveShift(){ try{ const res=await fetch('/api/saveShift',{method:'POST',headers:{'Content-Type':'application/json'}, body:JSON.stringify({shift:currentShift,sha:currentSha})}); const data=await res.json(); if(data.message){alert(data.message); if(data.sha) currentSha=data.sha;} if(data.error&&data.error.includes('sha')){alert('Файл обновился, данные будут перезагружены.'); await loadShift();} }catch(e){alert('Ошибка сохранения: '+e.message);} }
function renderSummary(){let counts={СОГНУТЫ:0,СВАРЕНЫ:0,УПАКОВАНЫ:0}; for(let cat in currentShift){for(let prod in currentShift[cat]){stages.forEach(s=>counts[s]+=currentShift[cat][prod][s]);}} document.getElementById('summary').textContent=`СОГНУТЫ: ${counts.СОГНУТЫ} | СВАРЕНЫ: ${counts.СВАРЕНЫ} | УПАКОВАНЫ: ${counts.УПАКОВАНЫ}`;}
function renderStage(){ const container=document.getElementById('stageContainer'); container.innerHTML=''; renderSummary(); for(let cat in currentShift){for(let prod in currentShift[cat]){ const card=document.createElement('div'); card.className='card'; const total=stages.reduce((sum,s)=>sum+currentShift[cat][prod][s],0); const stageVal=currentShift[cat][prod][activeStage]; const percent=total?Math.min(100,Math.round(stageVal/total*100)):0; if(percent===100) card.classList.add('green'); else if(percent>0) card.classList.add('yellow'); const color=activeStage==='СОГНУТЫ'?'#00bfff':activeStage==='СВАРЕНЫ'?'#ffa500':'#00ff00'; card.innerHTML=`<div class="card-title">${cat} - ${prod}</div><input type="number" min="0" value="${stageVal}" data-cat="${cat}" data-prod="${prod}" style="width:60px"><div class="progress-bar"><div class="progress-fill" style="width:${percent}%; background-color:${color}"></div></div>`; container.appendChild(card); } }
container.querySelectorAll('input[type="number"]').forEach(input=>{ input.addEventListener('input',e=>{ const cat=e.target.dataset.cat, prod=e.target.dataset.prod; let val=parseInt(e.target.value); if(isNaN(val)||val<0) val=0; e.target.value=val; currentShift[cat][prod][activeStage]=val; const total=stages.reduce((sum,s)=>sum+currentShift[cat][prod][s],0); const stageVal=currentShift[cat][prod][activeStage]; const percent=total?Math.min(100,Math.round(stageVal/total*100)):0; e.target.parentElement.querySelector('.progress-fill').style.width=percent+'%'; });});}
loadShift();
</script>
</body>
</html>